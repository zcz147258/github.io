<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>SSR服务端渲染 | mikasa</title><meta name="keywords" content="SSR服务端渲染"><meta name="author" content="mikasa"><meta name="copyright" content="mikasa"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="SSR服务端渲染">
<meta property="og:type" content="article">
<meta property="og:title" content="SSR服务端渲染">
<meta property="og:url" content="http://yoursite.com/2020/11/30/SSR%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%B8%B2%E6%9F%93/index.html">
<meta property="og:site_name" content="mikasa">
<meta property="og:description" content="SSR服务端渲染">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://ss0.bdstatic.com/70cFuHSh_Q1YnxGkpoWK1HF6hhy/it/u=3519339501,3990679385&fm=26&gp=0.jpg">
<meta property="article:published_time" content="2020-11-30T07:28:46.350Z">
<meta property="article:modified_time" content="2020-11-30T08:52:56.187Z">
<meta property="article:author" content="mikasa">
<meta property="article:tag" content="Java,JavaScript,Node,Json,Sql,前端,数据库,后端">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://ss0.bdstatic.com/70cFuHSh_Q1YnxGkpoWK1HF6hhy/it/u=3519339501,3990679385&fm=26&gp=0.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://yoursite.com/2020/11/30/SSR%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%B8%B2%E6%9F%93/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":1,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  ClickShowText: undefined,
  lightbox: 'mediumZoom',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}

// https://stackoverflow.com/questions/16839698/jquery-getscript-alternative-in-native-javascript
const getScript = url => new Promise((resolve, reject) => {
  const script = document.createElement('script')
  script.src = url
  script.async = true
  script.onerror = reject
  script.onload = script.onreadystatechange = function() {
    const loadState = this.readyState
    if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
    script.onload = script.onreadystatechange = null
    resolve()
  }
  document.head.appendChild(script)
})</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2020-11-30 16:52:56'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
   if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }
  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}})()</script><meta name="generator" content="Hexo 5.2.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/img/index/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">55</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/source/categories/"><div class="headline">分类</div><div class="length-num">15</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标籤</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> 娱乐</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li><li><a class="site-page" href="/games/"><i class="fa-fw fas fa-video"></i><span> 游戏</span></a></li><li><a class="site-page" href="/books/"><i class="fa-fw fas fa-video"></i><span> 书籍</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://ss0.bdstatic.com/70cFuHSh_Q1YnxGkpoWK1HF6hhy/it/u=3519339501,3990679385&amp;fm=26&amp;gp=0.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">mikasa</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标籤</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> 娱乐</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li><li><a class="site-page" href="/games/"><i class="fa-fw fas fa-video"></i><span> 游戏</span></a></li><li><a class="site-page" href="/books/"><i class="fa-fw fas fa-video"></i><span> 书籍</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">SSR服务端渲染</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-11-30T07:28:46.350Z" title="发表于 2020-11-30 15:28:46">2020-11-30</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2020-11-30T08:52:56.187Z" title="更新于 2020-11-30 16:52:56">2020-11-30</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/source/categories/Node/">Node</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">5.9k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>28分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="1-SSR的优点和缺点"><a href="#1-SSR的优点和缺点" class="headerlink" title="1.SSR的优点和缺点"></a>1.SSR的优点和缺点</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">SSR的优点</span><br><span class="line">1. 更利于SEO。</span><br><span class="line">	使用了React或者其它MVVM框架之后，页面大多数DOM元素都是在客户端根据js动态生成，可供爬虫抓取分析的内容大大减少(如图一)。</span><br><span class="line">2.更利于首屏渲染</span><br><span class="line">	首屏的渲染是node发送过来的html字符串，并不依赖于js文件了，</span><br><span class="line">	</span><br><span class="line">SSR的局限</span><br><span class="line">1.服务端压力较大</span><br><span class="line">	本来是通过客户端完成渲染，现在统一到服务端node服务去做。尤其是高并发访问的情况，会大量占用服务端CPU资源；</span><br><span class="line">2.开发条件受限</span><br><span class="line">	在服务端渲染中，只会执行到componentDidMount之前的生命周期钩子，因此项目引用的第三方的库也不可用其它生命周期钩子，这对引用库的选择产生了很大的限制；</span><br><span class="line">3.学习成本相对较高</span><br><span class="line">	除了对webpack、React要熟悉，还需要掌握node、Koa2等相关技术。相对于客户端渲染，项目构建、部署过程更加复杂。</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">耗时比较</span><br><span class="line">	1.数据请求，</span><br><span class="line">	由服务端请求首屏数据，而不是客户端请求首屏数据，这是“快”的一个主要原因。服务端在内网进行请求，数据响应速度快。客户端在不同网络环境进行数据请求，且外网http请求开销大，导致时间差。</span><br><span class="line">	2.html渲染</span><br><span class="line">	服务端渲染是先向后端服务器请求数据，然后生成完整首屏html返回给浏览器；而客户端渲染是等js代码下载、加载、解析完成后再请求数据渲染，等待的过程页面是什么都没有的，就是用户看到的白屏。就是服务端渲染不需要等待js代码下载完成并请求数据，就可以返回一个已有完整数据的首屏页面。</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="2-Nuxt-js"><a href="#2-Nuxt-js" class="headerlink" title="2.Nuxt.js"></a>2.Nuxt.js</h1><h2 id="2-1安装"><a href="#2-1安装" class="headerlink" title="2.1安装"></a>2.1安装</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">前提安装 npm install vue-cli -g</span><br><span class="line">vue -V  检查版本</span><br><span class="line">vue init nuxt/starter    <span class="comment">//检查  使用 npm run dev  就是一个nuxt.js项目</span></span><br></pre></td></tr></table></figure>

<h2 id="2-2目录介绍"><a href="#2-2目录介绍" class="headerlink" title="2.2目录介绍"></a>2.2目录介绍</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">.nuxt 是自动生成</span><br><span class="line">assets    less  sass  js代码</span><br><span class="line">components  组件</span><br><span class="line">layouts   布局</span><br><span class="line">middleware   中间件</span><br><span class="line">node_modules  模块</span><br><span class="line">pages   页面</span><br><span class="line">plugins  插件</span><br><span class="line"><span class="keyword">static</span>  静态资源 图片等</span><br><span class="line">store   状态管理  </span><br><span class="line">eslint  代码校验</span><br><span class="line">editorconfig  配置编辑器</span><br><span class="line">gitignore   git上传忽略</span><br><span class="line">nuxt.config.js  配置头部标签</span><br><span class="line">package.json   配置命令打包等</span><br><span class="line"></span><br><span class="line">配置nuxt的端口域名</span><br><span class="line"> <span class="string">&quot;config&quot;</span>:&#123;</span><br><span class="line">     <span class="string">&quot;nuxt&quot;</span>:&#123;</span><br><span class="line">         <span class="string">&quot;host&quot;</span>:<span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line">         <span class="string">&quot;port&quot;</span>:<span class="string">&quot;1818&quot;</span></span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line">配置全局样式</span><br><span class="line">  css:[<span class="string">&#x27;~assets/normalize.css&#x27;</span>],</span><br><span class="line">  </span><br><span class="line">配置webpack	</span><br><span class="line">    loader:[</span><br><span class="line">          &#123;</span><br><span class="line">            test: <span class="regexp">/\.(png|jpg|jpeg|gif|svg)$/</span>,</span><br><span class="line">            loader:<span class="string">&quot;url-loader&quot;</span>,</span><br><span class="line">            query:&#123;</span><br><span class="line">              limit:<span class="number">10000</span>,</span><br><span class="line">              name:<span class="string">&#x27;img/[name].[hash].[ext]&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        ],</span><br></pre></td></tr></table></figure>

<h2 id="2-3路由"><a href="#2-3路由" class="headerlink" title="2.3路由"></a>2.3路由</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">nuxt.js  路由是自动生成的</span><br><span class="line">&lt;ul&gt;</span><br><span class="line">	&lt;li&gt;<span class="xml"><span class="tag">&lt;<span class="name">nuxt-link</span> <span class="attr">:to</span>=<span class="string">&quot;&#123;name:&#x27;index&#x27;&#125;&quot;</span>&gt;</span>Home<span class="tag">&lt;/<span class="name">nuxt-link</span>&gt;</span></span>&lt;/li&gt;</span><br><span class="line">	&lt;li&gt;<span class="xml"><span class="tag">&lt;<span class="name">nuxt-link</span> <span class="attr">:to</span>=<span class="string">&quot;&#123;name:&#x27;about&#x27;&#125;&quot;</span>&gt;</span>About<span class="tag">&lt;/<span class="name">nuxt-link</span>&gt;</span></span>&lt;/li&gt;</span><br><span class="line">	&lt;li&gt;<span class="xml"><span class="tag">&lt;<span class="name">nuxt-link</span> <span class="attr">:to</span>=<span class="string">&quot;&#123;name:&#x27;news&#x27;&#125;&quot;</span>&gt;</span>News<span class="tag">&lt;/<span class="name">nuxt-link</span>&gt;</span></span>&lt;/li&gt;</span><br><span class="line">&lt;/ul&gt;</span><br><span class="line"></span><br><span class="line">传递参数 </span><br><span class="line">	&lt;li&gt;<span class="xml"><span class="tag">&lt;<span class="name">nuxt-link</span> <span class="attr">:to</span>=<span class="string">&quot;&#123;name:&#x27;index&#x27;,params:&#123;newsId:3306&#125;&#125;&quot;</span>&gt;</span>Home<span class="tag">&lt;/<span class="name">nuxt-link</span>&gt;</span></span>&lt;/li&gt;</span><br><span class="line">获取参数</span><br><span class="line">	&#123;&#123; $route.params.newsId &#125;&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-4动态路由"><a href="#2-4动态路由" class="headerlink" title="2.4动态路由"></a>2.4动态路由</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">下划线开始的动态路由</span><br><span class="line">&lt;li&gt;<span class="xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/news/123&quot;</span>&gt;</span>news-1<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span>&lt;/li&gt;</span><br><span class="line">&lt;li&gt;<span class="xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/news/456&quot;</span>&gt;</span>news-2<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span>&lt;/li&gt;</span><br><span class="line"></span><br><span class="line">参数校验 </span><br><span class="line">	<span class="function"><span class="title">validate</span>(<span class="params">&#123;params&#125;</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="regexp">/^\d+$/</span>.test(params.id)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-5过度"><a href="#2-5过度" class="headerlink" title="2.5过度"></a>2.5过度</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">必须使用 nuxt-link 标签</span><br><span class="line"><span class="comment">/* css过度页面 */</span></span><br><span class="line">.page-enter-active,.page-leave-active&#123;</span><br><span class="line">    transition: all <span class="number">0.</span>5s;</span><br><span class="line">&#125;</span><br><span class="line">.page-enter,.page-leave-active&#123;</span><br><span class="line">    opacity: <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">.test-enter-active,.test-leave-active&#123;</span><br><span class="line">    transition: all <span class="number">0.</span>5s;</span><br><span class="line">    font-size: 12px;</span><br><span class="line">&#125;</span><br><span class="line">.test-enter,.test-leave-active&#123;</span><br><span class="line">    opacity: <span class="number">0</span>;</span><br><span class="line">    font-size: 20px;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  transition:<span class="string">&#x27;test&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-6默认模板和默认布局"><a href="#2-6默认模板和默认布局" class="headerlink" title="2.6默认模板和默认布局"></a>2.6默认模板和默认布局</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">名字  app.html</span><br><span class="line">默认模板和默认布局大同小异</span><br></pre></td></tr></table></figure>

<h2 id="2-7错误页面和个性meta标签设置"><a href="#2-7错误页面和个性meta标签设置" class="headerlink" title="2.7错误页面和个性meta标签设置"></a>2.7错误页面和个性meta标签设置</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">新建一个error   <span class="number">404</span>找不到就会显示</span><br><span class="line"></span><br><span class="line">设置头部</span><br><span class="line">	js代码里面</span><br><span class="line">	<span class="function"><span class="title">head</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span>&#123;</span><br><span class="line">            title:<span class="built_in">this</span>.title,</span><br><span class="line">            meta:[</span><br><span class="line">                &#123;<span class="attr">hid</span>:<span class="string">&#x27;bbb&#x27;</span>,name：<span class="string">&#x27;news1&#x27;</span>,<span class="attr">content</span>:<span class="string">&#x27;This is  new info&#x27;</span>&#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-8异步请求数据"><a href="#2-8异步请求数据" class="headerlink" title="2.8异步请求数据"></a>2.8异步请求数据</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">asyncData</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> axios.get(<span class="string">&#x27;https://api.myjson.com/?&#x27;</span>)</span><br><span class="line">    .then(<span class="function">(<span class="params">res</span>)=&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="attr">info</span>:res.data&#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-9生成静态资源"><a href="#2-9生成静态资源" class="headerlink" title="2.9生成静态资源"></a>2.9生成静态资源</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~代表项目根目录下</span><br><span class="line">打包 npm run generate</span><br><span class="line"></span><br><span class="line">npm install -g live-server</span><br><span class="line">使用live-server</span><br></pre></td></tr></table></figure>

<h1 id="3-Next-js"><a href="#3-Next-js" class="headerlink" title="3.Next.js"></a>3.Next.js</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yarn add react react-dom next</span><br><span class="line"></span><br><span class="line">手动配置</span><br><span class="line"></span><br><span class="line">使用create-next-app快速创建项目</span><br></pre></td></tr></table></figure>

<h2 id="3-1创建"><a href="#3-1创建" class="headerlink" title="3.1创建"></a>3.1创建</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npx create-next-app  </span><br><span class="line">yarn dev  运行项目</span><br></pre></td></tr></table></figure>

<h2 id="3-2-page和component的使用"><a href="#3-2-page和component的使用" class="headerlink" title="3.2 page和component的使用"></a>3.2 page和component的使用</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">路由自动配置</span><br><span class="line">以及路由自动配置 </span><br><span class="line">二级路由 </span><br><span class="line">	文件夹的方式   http:<span class="comment">//localhost:3000/blog/nextblog</span></span><br><span class="line">	</span><br><span class="line">组件</span><br><span class="line">	<span class="keyword">export</span> <span class="keyword">default</span> (&#123;children&#125;)=&gt;<span class="xml"><span class="tag">&lt;<span class="name">button</span>&gt;</span>&#123;children&#125;<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line">	引入直接使用</span><br></pre></td></tr></table></figure>

<h2 id="3-2路由跳转"><a href="#3-2路由跳转" class="headerlink" title="3.2路由跳转"></a>3.2路由跳转</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">标签跳转 Link</span><br><span class="line">		 &lt;Link href=<span class="string">&quot;/blog/nextblog&quot;</span>&gt;<span class="xml"><span class="tag">&lt;<span class="name">a</span>&gt;</span>去博客页面<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span>&lt;/Link&gt;</span><br><span class="line">		  &lt;Link href=<span class="string">&quot;/&quot;</span>&gt;<span class="xml"><span class="tag">&lt;<span class="name">a</span>&gt;</span>返回首页<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span>&lt;/Link&gt;</span><br><span class="line">		  </span><br><span class="line">		  加A标签包裹起来</span><br><span class="line">编程跳转</span><br><span class="line">		<span class="keyword">import</span> Router <span class="keyword">from</span> <span class="string">&#x27;next/router&#x27;</span></span><br><span class="line">		&lt;div onClick=&#123;<span class="function">()=&gt;</span>&#123;Router.push(<span class="string">&#x27;/&#x27;</span>)&#125;&#125;&gt;</span><br><span class="line">        	返回首页</span><br><span class="line">        &lt;/div&gt;</span><br></pre></td></tr></table></figure>

<h2 id="3-3路由跳转传递参数接收参数"><a href="#3-3路由跳转传递参数接收参数" class="headerlink" title="3.3路由跳转传递参数接收参数"></a>3.3路由跳转传递参数接收参数</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">LInk  标签跳转</span><br><span class="line">	&lt;Link href=<span class="string">&quot;/blog/nextblog?name=结义&quot;</span>&gt;<span class="xml"><span class="tag">&lt;<span class="name">a</span>&gt;</span>结义<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span>&lt;<span class="regexp">/Link&gt;&lt;br&gt;&lt;/</span>br&gt;</span><br><span class="line">      &lt;Link href=<span class="string">&quot;/blog/nextblog?name=进空&quot;</span>&gt;<span class="xml"><span class="tag">&lt;<span class="name">a</span>&gt;</span>进空<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span>&lt;/Link&gt;</span><br><span class="line">      </span><br><span class="line">      接受</span><br><span class="line">      	<span class="keyword">import</span> &#123; withRouter &#125; <span class="keyword">from</span> <span class="string">&#x27;next/router&#x27;</span></span><br><span class="line">      	<span class="keyword">export</span> <span class="keyword">default</span> withRouter(NextBlog)</span><br><span class="line">      	 &lt;h2&gt;&#123;router.query.name&#125;&lt;/h2&gt;</span><br><span class="line"> 编程时传递</span><br><span class="line"> 		<span class="keyword">import</span> Router <span class="keyword">from</span> <span class="string">&#x27;next/router&#x27;</span></span><br><span class="line">        <span class="keyword">let</span> gotoname = <span class="function">()=&gt;</span>&#123;</span><br><span class="line">          Router.push(<span class="string">&#x27;/blog/nextblog?name=结义&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="number">2.</span>对象</span><br><span class="line">        	<span class="keyword">let</span> gotoname = <span class="function">()=&gt;</span>&#123;</span><br><span class="line">              Router.push(&#123;</span><br><span class="line">                pathname:<span class="string">&#x27;/blog/nextblog&#x27;</span>,</span><br><span class="line">                query:&#123;<span class="attr">name</span>:<span class="string">&#x27;进空&#x27;</span>&#125;</span><br><span class="line">              &#125;)</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-4路由中的钩子事件"><a href="#3-4路由中的钩子事件" class="headerlink" title="3.4路由中的钩子事件"></a>3.4路由中的钩子事件</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//routeChangeStart  1 11111</span></span><br><span class="line">  <span class="comment">//routeChangeComplete   </span></span><br><span class="line">  <span class="comment">//beforeHistoryChange   2222</span></span><br><span class="line">  <span class="comment">//routeChangeError  路由发生错误  </span></span><br><span class="line">  <span class="comment">//hashChangeStart</span></span><br><span class="line">  <span class="comment">//hashChangeComplete</span></span><br><span class="line">  Router.events.on(<span class="string">&#x27;routeChangeStart&#x27;</span>,<span class="function">(<span class="params">...args</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;11111&#x27;</span>,...args)</span><br><span class="line">  &#125;)</span><br><span class="line">  Router.events.on(<span class="string">&#x27;beforeHistoryChange&#x27;</span>,<span class="function">(<span class="params">...args</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;2222&#x27;</span>,...args)</span><br><span class="line">  &#125;)</span><br><span class="line">  Router.events.on(<span class="string">&#x27;routeChangeComplete&#x27;</span>,<span class="function">(<span class="params">...args</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;3333&#x27;</span>,...args)</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>

<h2 id="3-5获取远端数据axios"><a href="#3-5获取远端数据axios" class="headerlink" title="3.5获取远端数据axios"></a>3.5获取远端数据axios</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">getInitialProps</span><br><span class="line">	NextBlog.getInitialProps = <span class="keyword">async</span> ()=&gt;&#123;</span><br><span class="line">    <span class="keyword">const</span> promise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>)=&gt;</span>&#123;</span><br><span class="line">        axios(<span class="string">&#x27;http://rap2.taobao.org:38080/app/mock/256761/api/v1/article&#x27;</span>).then(<span class="function">(<span class="params">res</span>)=&gt;</span>&#123;</span><br><span class="line">            <span class="comment">// console.log(res)</span></span><br><span class="line">            resolve(res.data.data)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> promise</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> withRouter(NextBlog)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">接受</span><br><span class="line">		<span class="function"><span class="keyword">function</span> <span class="title">NextBlog</span>(<span class="params">&#123;router,list&#125;</span>)就可以拿到数据</span></span><br><span class="line"><span class="function">		</span></span><br><span class="line"><span class="function">		&lt;<span class="title">p</span>&gt;数据：</span>&#123;list.map(<span class="function">(<span class="params">item</span>)=&gt;</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> (</span><br><span class="line">            &lt;div&gt;&#123;item.title&#125;&lt;/div&gt;</span><br><span class="line">            )</span><br><span class="line">        &#125;)&#125;&lt;/p&gt;</span><br><span class="line">        </span><br><span class="line">        注意返回的结果和   list或者result接受的参数匹配上</span><br></pre></td></tr></table></figure>

<h2 id="3-6css样式"><a href="#3-6css样式" class="headerlink" title="3.6css样式"></a>3.6css样式</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;style jsx&gt;</span><br><span class="line">	&#123;</span><br><span class="line">        div&#123;</span><br><span class="line">            color:red</span><br><span class="line">        &#125;</span><br><span class="line">	&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<h2 id="3-7moment-js-处理时间"><a href="#3-7moment-js-处理时间" class="headerlink" title="3.7moment.js  处理时间"></a>3.7moment.js  处理时间</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">引入moment</span><br><span class="line">moment.dafault(<span class="built_in">Date</span>.now().format())</span><br><span class="line"></span><br><span class="line">懒加载 </span><br><span class="line">	<span class="keyword">const</span> moment  = <span class="keyword">await</span> <span class="keyword">import</span>(<span class="string">&#x27;moment&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="3-8SEO"><a href="#3-8SEO" class="headerlink" title="3.8SEO"></a>3.8SEO</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Head <span class="keyword">from</span> <span class="string">&#x27;next/head&#x27;</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Header</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span>(</span><br><span class="line">        &lt;&gt;</span><br><span class="line">            &lt;div&gt;Jspang.com&lt;/div&gt;</span><br><span class="line">            &lt;Head&gt;</span><br><span class="line">                &lt;title&gt;我是最棒的&lt;/title&gt;</span><br><span class="line">                &lt;meta charSet=<span class="string">&quot;utf-8&quot;</span>&gt;&lt;/meta&gt;</span><br><span class="line">            &lt;/Head&gt;</span><br><span class="line">        &lt;/&gt;</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-9打包的坑"><a href="#3-9打包的坑" class="headerlink" title="3.9打包的坑"></a>3.9打包的坑</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">antd的css样式不合适  需要全局引入   新建一个页面 app  抛出去</span><br></pre></td></tr></table></figure>

<h1 id="4-vue-SSR渲染"><a href="#4-vue-SSR渲染" class="headerlink" title="4.vue-SSR渲染"></a>4.vue-SSR渲染</h1><h2 id="4-1预渲染"><a href="#4-1预渲染" class="headerlink" title="4.1预渲染"></a>4.1预渲染</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">cnpm i prerender-spa-plugin</span><br><span class="line"><span class="comment">//预渲染</span></span><br><span class="line"><span class="keyword">const</span> PrerenderSpaPlugin= <span class="built_in">require</span>(<span class="string">&#x27;prerender-spa-plugin&#x27;</span>)</span><br><span class="line"><span class="comment">//调用渲染器</span></span><br><span class="line"><span class="keyword">const</span> Renderer = PrerenderSpaPlugin.PuppeteerRenderer</span><br><span class="line"><span class="keyword">const</span> env = <span class="built_in">require</span>(<span class="string">&#x27;../config/prod.env&#x27;</span>)</span><br><span class="line"></span><br><span class="line"> <span class="keyword">new</span> PrerenderSpaPlugin(&#123;</span><br><span class="line">      staticDir:path.join(__dirname,<span class="string">&#x27;../dist&#x27;</span>),</span><br><span class="line">      routes: [ <span class="string">&#x27;/&#x27;</span>,<span class="string">&#x27;/service&#x27;</span>,<span class="string">&#x27;/companyintroduction&#x27;</span>,<span class="string">&#x27;/jobchance&#x27;</span>,<span class="string">&#x27;/contactus&#x27;</span>,<span class="string">&#x27;/home&#x27;</span>],</span><br><span class="line">      renderer:<span class="keyword">new</span> Renderer(&#123;</span><br><span class="line">        inject:&#123;</span><br><span class="line">          foo:<span class="string">&#x27;far&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        headless:<span class="literal">false</span>,</span><br><span class="line">        <span class="comment">//项目的入口中使用</span></span><br><span class="line">        renderAfterDocumentEvent:<span class="string">&#x27;render-event&#x27;</span></span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="title">mounted</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">document</span>.dispatchEvent(<span class="keyword">new</span> Event(<span class="string">&#x27;render-event&#x27;</span>))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//assetsPublicPath: &#x27;/&#x27;,</span></span><br><span class="line"></span><br><span class="line">然后 npm run build</span><br><span class="line"></span><br><span class="line"><span class="comment">//全局安装  npm install http-server -g</span></span><br><span class="line"><span class="comment">// hs -o -p 9999</span></span><br><span class="line"><span class="comment">//预渲染不适用的场景</span></span><br><span class="line"><span class="comment">//什么场景下不适合使用预渲染</span></span><br><span class="line">　　预渲染不适用于渲染路由过多（不建议预渲染非常多的路由，因为这会严重拖慢你的构建进程） 和 动态路由 （如/detail/参数，因为页面内容依据看它的参数而显得不同），只是适用于几个简单的固定路由的情景（例如 /index /about /contact）</span><br><span class="line"><span class="comment">//SSR的优势</span></span><br><span class="line">SSR的优势</span><br><span class="line">　　（<span class="number">1</span>）更利于SEO：不同爬虫工作原理类似，只会爬取源码，不会执行网站的任何脚本（Google除外，据说Googlebot可以运行javaScript）。使用了React或者其它MVVM框架之后，页面大多数DOM元素都是在客户端根据js动态生成，可供爬虫抓取分析的内容大大减少。另外，浏览器爬虫不会等待我们的数据完成之后再去抓取我们的页面数据。服务端渲染返回给客户端的是已经获取了异步数据并执行JavaScript脚本的最终HTML，网络爬中就可以抓取到完整页面的信息。</span><br><span class="line">　　（<span class="number">2</span>）更利于首屏渲染：首屏的渲染是node发送过来的html字符串，并不依赖于js文件了，这就会使用户更快的看到页面的内容。尤其是针对大型单页应用，打包后文件体积比较大，普通客户端渲染加载所有所需文件时间较长，首页就会有一个很长的白屏等待时间。</span><br><span class="line"> <span class="comment">//服务端渲染与预渲染区别</span></span><br><span class="line">　　客户端渲染：用户访问 url，请求 html 文件，前端根据路由动态渲染页面内容。关键链路较长，有一定的白屏时间；</span><br><span class="line">　　服务端渲染：用户访问 url，服务端根据访问路径请求所需数据，拼接成 html 字符串，返回给前端。前端接收到 html 时已有部分内容；</span><br><span class="line">　　预渲染：构建阶段生成匹配预渲染路径的 html 文件（注意：每个需要预渲染的路由都有一个对应的 html）。构建出来的 html 文件已有部分内容</span><br><span class="line"> <span class="comment">//服务端渲染与预渲染共同点</span></span><br><span class="line">　　针对单页应用，服务端渲染和预渲染共同解决的问题：</span><br><span class="line">　　（<span class="number">1</span>）SEO：单页应用的网站内容是根据当前路径动态渲染的，html 文件中往往没有内容，网络爬虫不会等到页面脚本执行完再抓取；</span><br><span class="line">　　（<span class="number">2</span>）弱网环境：当用户在一个弱环境中访问你的站点时，你会想要尽可能快的将内容呈现给他们。甚至是在 js 脚本被加载和解析前；</span><br><span class="line">　　（<span class="number">3</span>）低版本浏览器：用户的浏览器可能不支持你使用的 js 特性，预渲染或服务端渲染能够让用户至少能够看到首屏的内容，而不是一个空白的网页。</span><br><span class="line">　　预渲染能与服务端渲染一样提高 SEO 优化，但前者比后者需要更少的配置，实现成本低。弱网环境下，预渲染能更快地呈现页面内容，减少页面可见时间。</span><br></pre></td></tr></table></figure>

<h2 id="4-2SSR"><a href="#4-2SSR" class="headerlink" title="4.2SSR"></a>4.2SSR</h2><h3 id="4-2-1webpack-server-conf-js"><a href="#4-2-1webpack-server-conf-js" class="headerlink" title="4.2.1webpack.server.conf.js"></a>4.2.1webpack.server.conf.js</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">npm i vue express vue-server-renderer</span><br><span class="line"><span class="comment">// 在package.json 里</span></span><br><span class="line"><span class="comment">//   &quot;server&quot;:&quot;webpack --config build/webpack.server.config.js&quot;</span></span><br><span class="line"><span class="comment">// 把basse.conf.js  的入口文件注释掉</span></span><br><span class="line"></span><br><span class="line"><span class="comment">///node_modules/vue-loader/lib/template-compiler/index.js</span></span><br><span class="line"><span class="comment">//遇见babel打吧错误</span></span><br><span class="line">    <span class="keyword">if</span> (!isProduction) &#123;</span><br><span class="line">      code = prettier.format(code, &#123; <span class="attr">semi</span>: <span class="literal">false</span>, <span class="attr">parser</span>: <span class="string">&#x27;babylon&#x27;</span> &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//babylon改为babel</span></span><br><span class="line"> <span class="keyword">if</span> (!isProduction) &#123;</span><br><span class="line">      code = prettier.format(code, &#123; <span class="attr">semi</span>: <span class="literal">false</span>, <span class="attr">parser</span>: <span class="string">&#x27;babel&#x27;</span> &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// cnpm i webpack-node-externals</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//  webpack.server.conf.js</span></span><br><span class="line"><span class="keyword">const</span> merge = <span class="built_in">require</span>(<span class="string">&#x27;webpack-merge&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> VueSSRServerPlugin = <span class="built_in">require</span>(<span class="string">&#x27;vue-server-renderer/server-plugin&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> nodeExternals = <span class="built_in">require</span>(<span class="string">&#x27;webpack-node-externals&#x27;</span>)</span><br><span class="line"><span class="comment">//引入配置</span></span><br><span class="line"><span class="keyword">const</span> base = <span class="built_in">require</span>(<span class="string">&#x27;./webpack.base.conf&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = merge(base,&#123;</span><br><span class="line">    target:<span class="string">&#x27;node&#x27;</span>,</span><br><span class="line">    devtool: <span class="string">&#x27;source-map&#x27;</span>,</span><br><span class="line">    entry:<span class="string">&#x27;./src/entry-server.js&#x27;</span>,</span><br><span class="line">    output:&#123;</span><br><span class="line">        filename: <span class="string">&#x27;bundle.server.js&#x27;</span>,</span><br><span class="line">        libraryTarget: <span class="string">&#x27;commonjs2&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    externals: nodeExternals(&#123;</span><br><span class="line">        <span class="comment">// 不要外置化 webpack 需要处理的依赖模块。</span></span><br><span class="line">        <span class="comment">// 你可以在这里添加更多的文件类型。例如，未处理 *.vue 原始文件，</span></span><br><span class="line">        <span class="comment">// 你还应该将修改 `global`（例如 polyfill）的依赖模块列入白名单</span></span><br><span class="line">        whitelist: <span class="regexp">/\.css$/</span></span><br><span class="line">    &#125;),</span><br><span class="line">    plugins:[</span><br><span class="line">        <span class="keyword">new</span> VueSSRServerPlugin()</span><br><span class="line">    ]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="4-2-2-entry-server-js"><a href="#4-2-2-entry-server-js" class="headerlink" title="4.2.2  entry-server.js"></a>4.2.2  entry-server.js</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createApp &#125; <span class="keyword">from</span> <span class="string">&#x27;./main&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> context =&gt;&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line">        <span class="comment">//创建路由</span></span><br><span class="line">        <span class="keyword">const</span> &#123; app &#125; = createApp()</span><br><span class="line">        <span class="keyword">const</span> router = app.$router</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> &#123; url &#125; = context</span><br><span class="line">        <span class="keyword">const</span> &#123; fullPath &#125; = router.resolve(url).route</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(fullPath !== url)&#123;</span><br><span class="line">            <span class="keyword">return</span> reject(&#123; <span class="attr">url</span>:fullPath &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//更改路由</span></span><br><span class="line">        router.push(url)</span><br><span class="line"></span><br><span class="line">        router.onReady(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">            <span class="keyword">const</span> matchedComponents = router.getMatchedComponents()</span><br><span class="line">            <span class="comment">//没有匹配的路由</span></span><br><span class="line">            <span class="keyword">if</span>(!matchedComponents.length)&#123;</span><br><span class="line">                <span class="keyword">return</span> reject(&#123;<span class="attr">code</span>: <span class="number">404</span>&#125;)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//匹配到路由</span></span><br><span class="line">            resolve(app)</span><br><span class="line">        &#125;,reject)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-2-3修改工厂模式"><a href="#4-2-3修改工厂模式" class="headerlink" title="4.2.3修改工厂模式"></a>4.2.3修改工厂模式</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//main.js</span></span><br><span class="line"><span class="comment">// main.js</span></span><br><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">&#x27;./App.vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; createRouter &#125; <span class="keyword">from</span> <span class="string">&#x27;./router&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; createStore &#125; <span class="keyword">from</span> <span class="string">&#x27;./store/store.js&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; sync &#125; <span class="keyword">from</span> <span class="string">&#x27;vuex-router-sync&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createApp</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line"> <span class="comment">// 创建 router 实例</span></span><br><span class="line"> <span class="keyword">const</span> router = createRouter()</span><br><span class="line"> <span class="keyword">const</span> store = createStore()</span><br><span class="line"></span><br><span class="line"> <span class="comment">// 同步路由状态(route state)到 store</span></span><br><span class="line"> sync(store, router)</span><br><span class="line"></span><br><span class="line"> <span class="keyword">const</span> app = <span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  <span class="comment">// 注入 router 到根 Vue 实例</span></span><br><span class="line">  router,</span><br><span class="line">  store,</span><br><span class="line">  render: <span class="function"><span class="params">h</span> =&gt;</span> h(App)</span><br><span class="line"> &#125;)</span><br><span class="line"></span><br><span class="line"> <span class="comment">// 返回 app 和 router</span></span><br><span class="line"> <span class="keyword">return</span> &#123; app, router, store &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//路由</span></span><br><span class="line">    <span class="comment">// router.js</span></span><br><span class="line">    <span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line">    <span class="keyword">import</span> Router <span class="keyword">from</span> <span class="string">&#x27;vue-router&#x27;</span></span><br><span class="line">    <span class="keyword">import</span> HelloWorld <span class="keyword">from</span> <span class="string">&#x27;@/components/HelloWorld&#x27;</span></span><br><span class="line"></span><br><span class="line">    Vue.use(Router)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">export</span> <span class="keyword">let</span> createRouter = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">     <span class="keyword">let</span> route = <span class="keyword">new</span> Router(&#123;</span><br><span class="line">      mode:<span class="string">&#x27;history&#x27;</span>,</span><br><span class="line">      routes: []</span><br><span class="line">     &#125;)</span><br><span class="line">     <span class="keyword">return</span> route</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//商店</span></span><br><span class="line">	<span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line">    <span class="keyword">import</span> Vuex <span class="keyword">from</span> <span class="string">&#x27;vuex&#x27;</span></span><br><span class="line"></span><br><span class="line">    Vue.use(Vuex)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createStore</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">new</span> Vuex.Store(&#123;</span><br><span class="line">      state: &#123;</span><br><span class="line">      &#125;,</span><br><span class="line">      actions: &#123;</span><br><span class="line">      &#125;,</span><br><span class="line">      mutations: &#123;</span><br><span class="line">      &#125;</span><br><span class="line">     &#125;)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-2-4客户端渲染"><a href="#4-2-4客户端渲染" class="headerlink" title="4.2.4客户端渲染"></a>4.2.4客户端渲染</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//webpack</span></span><br><span class="line"><span class="keyword">const</span> webpack = <span class="built_in">require</span>(<span class="string">&#x27;webpack&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> merge = <span class="built_in">require</span>(<span class="string">&#x27;webpack-merge&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> baseConfig = <span class="built_in">require</span>(<span class="string">&#x27;./webpack.base.conf.js&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> HtmlWebpackPlugin = <span class="built_in">require</span>(<span class="string">&#x27;html-webpack-plugin&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> VueSSRClientPlugin = <span class="built_in">require</span>(<span class="string">&#x27;vue-server-renderer/client-plugin&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = merge(baseConfig, &#123;</span><br><span class="line"> entry: <span class="string">&#x27;./src/entry-client.js&#x27;</span>,</span><br><span class="line"> plugins: [</span><br><span class="line">  <span class="keyword">new</span> webpack.optimize.CommonsChunkPlugin(&#123;</span><br><span class="line">   name: <span class="string">&quot;manifest&quot;</span>,</span><br><span class="line">   minChunks: <span class="literal">Infinity</span></span><br><span class="line">  &#125;),</span><br><span class="line">  <span class="comment">// 此插件在输出目录中</span></span><br><span class="line">  <span class="comment">// 生成 `vue-ssr-client-manifest.json`。</span></span><br><span class="line">  <span class="keyword">new</span> VueSSRClientPlugin(),</span><br><span class="line">  <span class="keyword">new</span> HtmlWebpackPlugin(&#123;</span><br><span class="line">   template: path.resolve(__dirname, <span class="string">&#x27;./../src/index.template.html&#x27;</span>),</span><br><span class="line">   filename: <span class="string">&#x27;index.template.html&#x27;</span></span><br><span class="line">  &#125;)</span><br><span class="line"> ]</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">   <span class="comment">//    &quot;client&quot;: &quot;webpack --config build/webpack.client.conf.js&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="5-2-5数据预取和存储"><a href="#5-2-5数据预取和存储" class="headerlink" title="5.2.5数据预取和存储"></a>5.2.5数据预取和存储</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">服务器渲染，可以理解为在被访问的时候，服务端做预渲染生成页面，上面说过，预渲染的缺点就是，实时数据的获取。所以如果应用程序依赖于一些异步数据，那么在开始渲染过程之前，需要先预取和解析好这些数据。</span><br><span class="line"></span><br><span class="line">另一个需要关注的问题是在客户端，在挂载 (mount) 到客户端应用程序之前，需要获取到与服务器端应用程序完全相同的数据 - 否则，客户端应用程序会因为使用与服务器端应用程序不同的状态，然后导致混合失败。这个地方上面提过，叫同构（服务端渲染一遍，客户端拿到数据再渲染一遍）。</span><br><span class="line"></span><br><span class="line"><span class="comment">//同构流程</span></span><br><span class="line">	客户端访问网站 —&gt; 服务器获取动态数据，生成页面，并把数据存入vuex中，然后返回html —&gt; 客户端获取html（此时已经返回了完整的页面） —&gt; 客户端获取到vuex的数据，并解析到vue里面，然后再一次找到根元素挂载vue,重复渲染页面。（同构阶段）</span><br><span class="line">官网 <span class="comment">//</span></span><br><span class="line"><span class="comment">//1.自定义函数asyncData</span></span><br><span class="line">	&lt;!-- Item.vue --&gt;</span><br><span class="line">    &lt;template&gt;</span><br><span class="line">     &lt;div&gt;&#123;&#123; item.title &#125;&#125;&lt;/div&gt;</span><br><span class="line">    &lt;/template&gt;</span><br><span class="line"></span><br><span class="line">    &lt;script&gt;</span><br><span class="line">    <span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">     asyncData (&#123; store, route &#125;) &#123;</span><br><span class="line">      <span class="comment">// 触发 action 后，会返回 Promise</span></span><br><span class="line">      <span class="keyword">return</span> store.dispatch(<span class="string">&#x27;fetchItem&#x27;</span>, route.params.id)</span><br><span class="line">     &#125;,</span><br><span class="line">     computed: &#123;</span><br><span class="line">      <span class="comment">// 从 store 的 state 对象中的获取 item。</span></span><br><span class="line">      item () &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="built_in">this</span>.$store.state.items[<span class="built_in">this</span>.$route.params.id]</span><br><span class="line">      &#125;</span><br><span class="line">     &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &lt;/script&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">//entry-server.js,</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// entry-server.js</span></span><br><span class="line">    <span class="keyword">import</span> &#123; createApp &#125; <span class="keyword">from</span> <span class="string">&#x27;./app&#x27;</span></span><br><span class="line">    <span class="keyword">export</span> <span class="keyword">default</span> context =&gt; &#123;</span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123; app, router, store &#125; = createApp()</span><br><span class="line"></span><br><span class="line">      router.push(context.url)</span><br><span class="line"></span><br><span class="line">      router.onReady(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">       <span class="keyword">const</span> matchedComponents = router.getMatchedComponents()</span><br><span class="line">       <span class="keyword">if</span> (!matchedComponents.length) &#123;</span><br><span class="line">        <span class="keyword">return</span> reject(&#123; <span class="attr">code</span>: <span class="number">404</span> &#125;)</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 对所有匹配的路由组件调用 `asyncData()`</span></span><br><span class="line">       <span class="built_in">Promise</span>.all(matchedComponents.map(<span class="function"><span class="params">Component</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (Component.asyncData) &#123;</span><br><span class="line">         <span class="keyword">return</span> Component.asyncData(&#123;</span><br><span class="line">          store,</span><br><span class="line">          route: router.currentRoute</span><br><span class="line">         &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">       &#125;)).then(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 在所有预取钩子(preFetch hook) resolve 后，</span></span><br><span class="line">        <span class="comment">// 我们的 store 现在已经填充入渲染应用程序所需的状态。</span></span><br><span class="line">        <span class="comment">// 当我们将状态附加到上下文，</span></span><br><span class="line">        <span class="comment">// 并且 `template` 选项用于 renderer 时，</span></span><br><span class="line">        <span class="comment">// 状态将自动序列化为 `window.__INITIAL_STATE__`，并注入 HTML。</span></span><br><span class="line">        context.state = store.state</span><br><span class="line"></span><br><span class="line">        resolve(app)</span><br><span class="line">       &#125;).catch(reject)</span><br><span class="line">      &#125;, reject)</span><br><span class="line">     &#125;)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-2-6客户端入口"><a href="#5-2-6客户端入口" class="headerlink" title="5.2.6客户端入口"></a>5.2.6客户端入口</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; app, router, store &#125; = createApp()</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">window</span>.__INITIAL_STATE__) &#123;</span><br><span class="line"> store.replaceState(<span class="built_in">window</span>.__INITIAL_STATE__)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-3-7服务端"><a href="#5-3-7服务端" class="headerlink" title="5.3.7服务端"></a>5.3.7服务端</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&quot;express&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"><span class="keyword">let</span> path = <span class="built_in">require</span>(<span class="string">&quot;path&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> server = express()</span><br><span class="line"><span class="keyword">const</span> &#123; createBundleRenderer &#125; = <span class="built_in">require</span>(<span class="string">&#x27;vue-server-renderer&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> renderer</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> resolve = <span class="function"><span class="params">file</span> =&gt;</span> path.resolve(__dirname, file)</span><br><span class="line"><span class="keyword">const</span> templatePath = resolve(<span class="string">&#x27;./src/index.template.html&#x27;</span>)</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createRenderer</span> (<span class="params">bundle, options</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">return</span> createBundleRenderer(bundle, <span class="built_in">Object</span>.assign(options, &#123;</span><br><span class="line">  runInNewContext: <span class="literal">false</span></span><br><span class="line"> &#125;))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> template = fs.readFileSync(templatePath, <span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> bundle = <span class="built_in">require</span>(<span class="string">&#x27;./dist/vue-ssr-server-bundle.json&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> clientManifest = <span class="built_in">require</span>(<span class="string">&#x27;./dist/vue-ssr-client-manifest.json&#x27;</span>)</span><br><span class="line">renderer = createRenderer(bundle, &#123;</span><br><span class="line"> template,</span><br><span class="line"> clientManifest</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">server.use(express.static(<span class="string">&#x27;./dist&#x27;</span>))</span><br><span class="line"><span class="comment">// 在服务器处理函数中……</span></span><br><span class="line">server.get(<span class="string">&#x27;*&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line"> <span class="keyword">const</span> context = &#123; <span class="attr">url</span>: req.url &#125;</span><br><span class="line"> <span class="comment">// 这里无需传入一个应用程序，因为在执行 bundle 时已经自动创建过。</span></span><br><span class="line"> renderer.renderToString(context, <span class="function">(<span class="params">err, html</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 处理异常……</span></span><br><span class="line">  res.end(html)</span><br><span class="line"> &#125;)</span><br><span class="line">&#125;)</span><br><span class="line">server.listen(<span class="number">3001</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;服务已开启&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="5-3-8热更新和本地调试"><a href="#5-3-8热更新和本地调试" class="headerlink" title="5.3.8热更新和本地调试"></a>5.3.8热更新和本地调试</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">server.dev.conf.js</span><br><span class="line"><span class="comment">//server.dev.conf.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> MFS = <span class="built_in">require</span>(<span class="string">&#x27;memory-fs&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> webpack = <span class="built_in">require</span>(<span class="string">&#x27;webpack&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> chokidar = <span class="built_in">require</span>(<span class="string">&#x27;chokidar&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> clientConfig = <span class="built_in">require</span>(<span class="string">&#x27;./webpack.client.conf.js&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> serverConfig = <span class="built_in">require</span>(<span class="string">&#x27;./webpack.server.conf.js&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> readFile = <span class="function">(<span class="params">fs, file</span>) =&gt;</span> &#123;</span><br><span class="line"> <span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> fs.readFileSync(path.join(clientConfig.output.path, file), <span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"> &#125; <span class="keyword">catch</span> (e) &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> <span class="title">setupDevServer</span> (<span class="params">app, templatePath, cb</span>) </span>&#123;</span><br><span class="line"> <span class="keyword">let</span> bundle</span><br><span class="line"> <span class="keyword">let</span> template</span><br><span class="line"> <span class="keyword">let</span> clientManifest</span><br><span class="line"></span><br><span class="line"> <span class="keyword">let</span> ready</span><br><span class="line"> <span class="keyword">const</span> readyPromise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">r</span> =&gt;</span> &#123; ready = r &#125;)</span><br><span class="line"> <span class="keyword">const</span> update = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (bundle &amp;&amp; clientManifest) &#123;</span><br><span class="line">   ready()</span><br><span class="line">   cb(bundle, &#123;</span><br><span class="line">    template,</span><br><span class="line">    clientManifest</span><br><span class="line">   &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// read template from disk and watch</span></span><br><span class="line"> template = fs.readFileSync(templatePath, <span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"> chokidar.watch(templatePath).on(<span class="string">&#x27;change&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  template = fs.readFileSync(templatePath, <span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;index.html template updated.&#x27;</span>)</span><br><span class="line">  update()</span><br><span class="line"> &#125;)</span><br><span class="line"></span><br><span class="line"> <span class="comment">// modify client config to work with hot middleware</span></span><br><span class="line"> clientConfig.entry.app = [<span class="string">&#x27;webpack-hot-middleware/client&#x27;</span>, clientConfig.entry.app]</span><br><span class="line"> clientConfig.output.filename = <span class="string">&#x27;[name].js&#x27;</span></span><br><span class="line"> clientConfig.plugins.push(</span><br><span class="line">  <span class="keyword">new</span> webpack.HotModuleReplacementPlugin(),</span><br><span class="line">  <span class="keyword">new</span> webpack.NoEmitOnErrorsPlugin()</span><br><span class="line"> )</span><br><span class="line"></span><br><span class="line"> <span class="comment">// dev middleware</span></span><br><span class="line"> <span class="keyword">const</span> clientCompiler = webpack(clientConfig)</span><br><span class="line"> <span class="keyword">const</span> devMiddleware = <span class="built_in">require</span>(<span class="string">&#x27;webpack-dev-middleware&#x27;</span>)(clientCompiler, &#123;</span><br><span class="line">  publicPath: clientConfig.output.publicPath,</span><br><span class="line">  noInfo: <span class="literal">true</span></span><br><span class="line"> &#125;)</span><br><span class="line"> app.use(devMiddleware)</span><br><span class="line"> clientCompiler.plugin(<span class="string">&#x27;done&#x27;</span>, <span class="function"><span class="params">stats</span> =&gt;</span> &#123;</span><br><span class="line">  stats = stats.toJson()</span><br><span class="line">  stats.errors.forEach(<span class="function"><span class="params">err</span> =&gt;</span> <span class="built_in">console</span>.error(err))</span><br><span class="line">  stats.warnings.forEach(<span class="function"><span class="params">err</span> =&gt;</span> <span class="built_in">console</span>.warn(err))</span><br><span class="line">  <span class="keyword">if</span> (stats.errors.length) <span class="keyword">return</span></span><br><span class="line">  clientManifest = <span class="built_in">JSON</span>.parse(readFile(</span><br><span class="line">   devMiddleware.fileSystem,</span><br><span class="line">   <span class="string">&#x27;vue-ssr-client-manifest.json&#x27;</span></span><br><span class="line">  ))</span><br><span class="line">  update()</span><br><span class="line"> &#125;)</span><br><span class="line"></span><br><span class="line"> <span class="comment">// hot middleware</span></span><br><span class="line"> app.use(<span class="built_in">require</span>(<span class="string">&#x27;webpack-hot-middleware&#x27;</span>)(clientCompiler, &#123; <span class="attr">heartbeat</span>: <span class="number">5000</span> &#125;))</span><br><span class="line"></span><br><span class="line"> <span class="comment">// watch and update server renderer</span></span><br><span class="line"> <span class="keyword">const</span> serverCompiler = webpack(serverConfig)</span><br><span class="line"> <span class="keyword">const</span> mfs = <span class="keyword">new</span> MFS()</span><br><span class="line"> serverCompiler.outputFileSystem = mfs</span><br><span class="line"> serverCompiler.watch(&#123;&#125;, <span class="function">(<span class="params">err, stats</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (err) <span class="keyword">throw</span> err</span><br><span class="line">  stats = stats.toJson()</span><br><span class="line">  <span class="keyword">if</span> (stats.errors.length) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// read bundle generated by vue-ssr-webpack-plugin</span></span><br><span class="line">  bundle = <span class="built_in">JSON</span>.parse(readFile(mfs, <span class="string">&#x27;vue-ssr-server-bundle.json&#x27;</span>))</span><br><span class="line">  update()</span><br><span class="line"> &#125;)</span><br><span class="line"></span><br><span class="line"> <span class="keyword">return</span> readyPromise</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//server.js  修改</span></span><br><span class="line"><span class="comment">//server.js</span></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&quot;express&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"><span class="keyword">let</span> path = <span class="built_in">require</span>(<span class="string">&quot;path&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> server = express()</span><br><span class="line"><span class="keyword">const</span> &#123; createBundleRenderer &#125; = <span class="built_in">require</span>(<span class="string">&#x27;vue-server-renderer&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> isProd = process.env.NODE_ENV === <span class="string">&#x27;production&#x27;</span></span><br><span class="line"><span class="keyword">let</span> renderer</span><br><span class="line"><span class="keyword">let</span> readyPromise</span><br><span class="line"><span class="keyword">const</span> resolve = <span class="function"><span class="params">file</span> =&gt;</span> path.resolve(__dirname, file)</span><br><span class="line"><span class="keyword">const</span> templatePath = resolve(<span class="string">&#x27;./src/index.template.html&#x27;</span>)</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createRenderer</span> (<span class="params">bundle, options</span>) </span>&#123;</span><br><span class="line"> <span class="keyword">return</span> createBundleRenderer(bundle, <span class="built_in">Object</span>.assign(options, &#123;</span><br><span class="line">  runInNewContext: <span class="literal">false</span></span><br><span class="line"> &#125;))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(isProd)&#123;</span><br><span class="line"> <span class="keyword">const</span> template = fs.readFileSync(templatePath, <span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"> <span class="keyword">const</span> bundle = <span class="built_in">require</span>(<span class="string">&#x27;./dist/vue-ssr-server-bundle.json&#x27;</span>)</span><br><span class="line"> <span class="keyword">const</span> clientManifest = <span class="built_in">require</span>(<span class="string">&#x27;./dist/vue-ssr-client-manifest.json&#x27;</span>)</span><br><span class="line"> renderer = createRenderer(bundle, &#123;</span><br><span class="line">  template,</span><br><span class="line">  clientManifest</span><br><span class="line"> &#125;)</span><br><span class="line"></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"> readyPromise = <span class="built_in">require</span>(<span class="string">&#x27;./build/server.dev.conf.js&#x27;</span>)(</span><br><span class="line">  server,</span><br><span class="line">  templatePath,</span><br><span class="line">  (bundle, options) =&gt; &#123;</span><br><span class="line">   renderer = createRenderer(bundle, options)</span><br><span class="line">  &#125;</span><br><span class="line"> )</span><br><span class="line">&#125;</span><br><span class="line">server.use(express.static(<span class="string">&#x27;./dist&#x27;</span>))</span><br><span class="line"><span class="comment">// 在服务器处理函数中……</span></span><br><span class="line">server.get(<span class="string">&#x27;*&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line"> <span class="keyword">const</span> context = &#123; <span class="attr">url</span>: req.url &#125;</span><br><span class="line"> <span class="comment">// 这里无需传入一个应用程序，因为在执行 bundle 时已经自动创建过。</span></span><br><span class="line"> <span class="comment">// 现在我们的服务器与应用程序已经解耦！</span></span><br><span class="line"> <span class="keyword">if</span>(isProd)&#123;</span><br><span class="line">  renderer.renderToString(context, <span class="function">(<span class="params">err, html</span>) =&gt;</span> &#123;</span><br><span class="line">   <span class="comment">// 处理异常……</span></span><br><span class="line">   res.end(html)</span><br><span class="line">  &#125;)</span><br><span class="line"> &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">  readyPromise.then(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">   renderer.renderToString(context, <span class="function">(<span class="params">err, html</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 处理异常……</span></span><br><span class="line">    res.end(html)</span><br><span class="line">   &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line"> &#125;</span><br><span class="line">&#125;)</span><br><span class="line">server.listen(<span class="number">3001</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;服务已开启&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h1 id="5-nextjs-博客实战"><a href="#5-nextjs-博客实战" class="headerlink" title="5.nextjs 博客实战"></a>5.nextjs 博客实战</h1><h2 id="5-1准备"><a href="#5-1准备" class="headerlink" title="5.1准备"></a>5.1准备</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">cnpm i -g create-next-app</span><br><span class="line">npx create-next-app react_blog_front</span><br><span class="line">yarn dev</span><br><span class="line"></span><br><span class="line"><span class="comment">//支持使用css</span></span><br><span class="line">yarn add @zeit/next-css</span><br><span class="line"></span><br><span class="line"><span class="comment">//yarn and antd</span></span><br><span class="line"><span class="comment">//按需加载</span></span><br><span class="line"><span class="comment">//yarn add babel-plugin-import</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//配置babel 和 css插件</span></span><br><span class="line"><span class="comment">//babelrc</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;presets&quot;</span>: [<span class="string">&quot;next/babel&quot;</span>],</span><br><span class="line">    <span class="string">&quot;plugins&quot;</span>: [</span><br><span class="line">        [</span><br><span class="line">            <span class="string">&quot;import&quot;</span>,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;libraryName&quot;</span>:<span class="string">&quot;antd&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//next.config.js</span></span><br><span class="line"><span class="keyword">const</span> WithCss = <span class="built_in">require</span>(<span class="string">&#x27;@zeit/next-css&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">typeof</span> <span class="built_in">require</span> !== <span class="literal">undefined</span>)&#123;</span><br><span class="line">    <span class="built_in">require</span>.extensions[<span class="string">&#x27;css&#x27;</span>] = <span class="function"><span class="params">file</span> =&gt;</span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = WithCss(&#123;&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">//引入less</span></span><br><span class="line">cnpm install --save @zeit/next-less node-less</span><br></pre></td></tr></table></figure>

<h2 id="5-2实战头部"><a href="#5-2实战头部" class="headerlink" title="5.2实战头部"></a>5.2实战头部</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;公共头部</span><br><span class="line"> &lt;div className&#x3D;&quot;header&quot;&gt;</span><br><span class="line">      &lt;Row type&#x3D;&quot;flex&quot; justify&#x3D;&quot;center&quot;&gt;</span><br><span class="line">        &lt;Col className&#x3D;&quot;header-left&quot;&gt;</span><br><span class="line">          &lt;span className&#x3D;&quot;header-logo&quot;&gt;mikasa&lt;&#x2F;span&gt;</span><br><span class="line">          &lt;span className&#x3D;&quot;header-txt&quot;&gt;专注前端开发&lt;&#x2F;span&gt;</span><br><span class="line">        &lt;&#x2F;Col&gt;</span><br><span class="line">        &lt;Col&gt;</span><br><span class="line">          &lt;Menu mode&#x3D;&quot;horizontal&quot;&gt;</span><br><span class="line">            &lt;Menu.Item</span><br><span class="line">              key&#x3D;&quot;home&quot;</span><br><span class="line">              className&#x3D;&quot;header-right-item&quot;</span><br><span class="line">              icon&#x3D;&#123;&lt;BookOutlined &#x2F;&gt;&#125;</span><br><span class="line">            &gt;</span><br><span class="line">              首页</span><br><span class="line">            &lt;&#x2F;Menu.Item&gt;</span><br><span class="line">            &lt;Menu.Item</span><br><span class="line">              key&#x3D;&quot;blog&quot;</span><br><span class="line">              className&#x3D;&quot;header-right-item&quot;</span><br><span class="line">              icon&#x3D;&#123;&lt;FileWordOutlined &#x2F;&gt;&#125;</span><br><span class="line">            &gt;</span><br><span class="line">              博客</span><br><span class="line">            &lt;&#x2F;Menu.Item&gt;</span><br><span class="line">            &lt;Menu.Item</span><br><span class="line">              key&#x3D;&quot;note&quot;</span><br><span class="line">              className&#x3D;&quot;header-right-item&quot;</span><br><span class="line">              icon&#x3D;&#123;&lt;ContainerOutlined &#x2F;&gt;&#125;</span><br><span class="line">            &gt;</span><br><span class="line">              笔记</span><br><span class="line">            &lt;&#x2F;Menu.Item&gt;</span><br><span class="line">            &lt;Menu.Item</span><br><span class="line">              key&#x3D;&quot;github&quot;</span><br><span class="line">              className&#x3D;&quot;header-right-item&quot;</span><br><span class="line">              icon&#x3D;&#123;&lt;GithubOutlined &#x2F;&gt;&#125;</span><br><span class="line">            &gt;</span><br><span class="line">              点赞</span><br><span class="line">            &lt;&#x2F;Menu.Item&gt;</span><br><span class="line">          &lt;&#x2F;Menu&gt;</span><br><span class="line">        &lt;&#x2F;Col&gt;</span><br><span class="line">      &lt;&#x2F;Row&gt;</span><br><span class="line">    &lt;&#x2F;div&gt;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;头部样式</span><br><span class="line">.header &#123;</span><br><span class="line">    background-color: #fff;</span><br><span class="line">    overflow: hidden;</span><br><span class="line">    height: 2.8rem;</span><br><span class="line">    border-bottom: 1px solid #fff;</span><br><span class="line">    font-size: 1.2rem;</span><br><span class="line">    font-weight: bolder;</span><br><span class="line">    padding: 0.3rem;</span><br><span class="line">    box-sizing: content-box;</span><br><span class="line"></span><br><span class="line">    .header-left &#123;</span><br><span class="line">        margin-right: 10rem;</span><br><span class="line"></span><br><span class="line">        .header-logo &#123;</span><br><span class="line">            line-height: 2.8rem;</span><br><span class="line">            color: rgb(46, 157, 221);</span><br><span class="line">            font-size: 1.5rem;</span><br><span class="line">            margin-right: .4rem;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        .header-txt &#123;</span><br><span class="line">            line-height: 2.8rem;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    .header-right-item &#123;</span><br><span class="line">        font-size: 1rem;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    .header-right-item svg &#123;</span><br><span class="line">        font-size: 1.2rem;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @media screen and (max-width: 375px) &#123;</span><br><span class="line">        height: 7rem;</span><br><span class="line">        .header-left &#123;</span><br><span class="line">            margin-right: 1rem;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-3markdown代码高亮"><a href="#5-3markdown代码高亮" class="headerlink" title="5.3markdown代码高亮"></a>5.3markdown代码高亮</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line">import marked from &quot;marked&quot;;</span><br><span class="line">import hljs from &quot;highlight.js&quot;;</span><br><span class="line">import MarkNav from &quot;markdown-navbar&quot;;</span><br><span class="line">import &quot;highlight.js&#x2F;styles&#x2F;monokai-sublime.css&quot;;</span><br><span class="line"></span><br><span class="line">var [data, setData] &#x3D; useState(&#39;loading....&#39;);</span><br><span class="line">  useEffect(() &#x3D;&gt; &#123;</span><br><span class="line">    &#x2F;&#x2F; marked相关配置</span><br><span class="line">    marked.setOptions(&#123;</span><br><span class="line">      renderer: new marked.Renderer(),</span><br><span class="line">      gfm: true,</span><br><span class="line">      pedantic: false,</span><br><span class="line">      sanitize: false,</span><br><span class="line">      tables: true,</span><br><span class="line">      breaks: true,</span><br><span class="line">      smartLists: true,</span><br><span class="line">      smartypants: true,</span><br><span class="line">      highlight: function (code) &#123;</span><br><span class="line">        return hljs.highlightAuto(code).value;</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line">    Readfile(&#123; fileid: &quot;015d1d96-9d66-424d-b9d9-34d6a9439cea.md&quot; &#125;).then(</span><br><span class="line">      (res) &#x3D;&gt; &#123;</span><br><span class="line">        setData(res);</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line">  &#125;, []);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> &lt;div</span><br><span class="line">     id&#x3D;&quot;content&quot;</span><br><span class="line">     className&#x3D;&quot;article-detail&quot;</span><br><span class="line">     dangerouslySetInnerHTML&#x3D;&#123;&#123;__html:marked(data)&#125;&#125;</span><br><span class="line">     &#x2F;&gt;</span><br><span class="line"></span><br><span class="line"> &lt;div className&#x3D;&quot;detailed-nav comm-box&quot;&gt;</span><br><span class="line">    &lt;div className&#x3D;&quot;nav-title&quot;&gt;文章目录&lt;&#x2F;div&gt;</span><br><span class="line">    &lt;MarkNav className&#x3D;&quot;article-menu&quot; source&#x3D;&#123;data&#125; ordered&#x3D;&#123;false&#125; &#x2F;&gt;</span><br><span class="line">&lt;&#x2F;div&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;对markdown样式的补充</span><br><span class="line">&#x2F;*对 markdown 样式的补充*&#x2F;</span><br><span class="line">pre &#123;</span><br><span class="line">    display: block;</span><br><span class="line">    padding: 10px;</span><br><span class="line">    margin: 0 0 10px;</span><br><span class="line">    font-size: 14px;</span><br><span class="line">    line-height: 1.42857143;</span><br><span class="line">    color: #abb2bf;</span><br><span class="line">    background: #282c34;</span><br><span class="line">    word-break: break-all;</span><br><span class="line">    word-wrap: break-word;</span><br><span class="line">    overflow: auto;</span><br><span class="line">&#125;</span><br><span class="line">h1,h2,h3,h4,h5,h6&#123;</span><br><span class="line">    margin-top: 1rem;</span><br><span class="line">    font-weight: bolder;</span><br><span class="line">    margin-bottom: 1rem;</span><br><span class="line">    &#x2F;* margin-bottom: 1em; *&#x2F;</span><br><span class="line">&#125;</span><br><span class="line">h1&#123;</span><br><span class="line">    font-size: 24px;</span><br><span class="line">    font-weight: bolder;</span><br><span class="line">&#125;</span><br><span class="line">strong &#123;</span><br><span class="line">    font-weight: bold;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">p &gt; code:not([class]) &#123;</span><br><span class="line">    padding: 2px 4px;</span><br><span class="line">    font-size: 90%;</span><br><span class="line">    color: #c7254e;</span><br><span class="line">    background-color: #f9f2f4;</span><br><span class="line">    border-radius: 4px;</span><br><span class="line">&#125;</span><br><span class="line">p img&#123;</span><br><span class="line">    &#x2F;* 图片居中 *&#x2F;</span><br><span class="line">    margin: 0 auto;</span><br><span class="line">    display: flex;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;*对 markdown 样式的补充*&#x2F;</span><br><span class="line">pre &#123;</span><br><span class="line">    display: block;</span><br><span class="line">    padding: .1rem;</span><br><span class="line">    margin: 0 0 5px;</span><br><span class="line">    font-size: 14px;</span><br><span class="line">    line-height: 1.42857143;</span><br><span class="line">    color: #000000;</span><br><span class="line">    background: #282c34;</span><br><span class="line">    word-break: break-all;</span><br><span class="line">    word-wrap: break-word;</span><br><span class="line">    overflow: auto;</span><br><span class="line">&#125;</span><br><span class="line">h1,h2,h3,h4,h5,h6&#123;</span><br><span class="line">    margin-top: 1em;</span><br><span class="line">    &#x2F;* margin-bottom: 1em; *&#x2F;</span><br><span class="line">&#125;</span><br><span class="line">strong &#123;</span><br><span class="line">    font-weight: bold;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">p &gt; code:not([class]) &#123;</span><br><span class="line">    padding: 2px 4px;</span><br><span class="line">    font-size: 90%;</span><br><span class="line">    color: #c7254e;</span><br><span class="line">    background-color: #f9f2f4;</span><br><span class="line">    border-radius: 4px;</span><br><span class="line">&#125;</span><br><span class="line">p img&#123;</span><br><span class="line">    &#x2F;* 图片居中 *&#x2F;</span><br><span class="line">    margin: 0 auto;</span><br><span class="line">    display: flex;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#content &#123;</span><br><span class="line">    font-family: &quot;Microsoft YaHei&quot;,  &#39;sans-serif&#39;;</span><br><span class="line">    font-size: 16px;</span><br><span class="line">    line-height: 30px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#content .desc ul,#content .desc ol &#123;</span><br><span class="line">    color: #333333;</span><br><span class="line">    margin: .3rem 0 0 25px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#content .desc h1, #content .desc h2 &#123;</span><br><span class="line">    border-bottom: 1px solid #eee;</span><br><span class="line">    padding-bottom: 10px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#content .desc a &#123;</span><br><span class="line">    color: #009a61;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="5-4Hooks的使用"><a href="#5-4Hooks的使用" class="headerlink" title="5.4Hooks的使用"></a>5.4Hooks的使用</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;hookes</span><br><span class="line">&#x2F;&#x2F;定义变量</span><br><span class="line">    const [data,setData] &#x3D; useState(&#123;description:&#39;&#39;&#125;)</span><br><span class="line">&#x2F;&#x2F;实现循环两次</span><br><span class="line">    useEffect(()&#x3D;&gt;&#123;</span><br><span class="line">        UserInfo(&#123;uid:props.uid&#125;).then(res&#x3D;&gt;&#123;</span><br><span class="line">          setData(res[0])</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;,[])</span><br><span class="line">&#x2F;&#x2F;实现componentDidMount </span><br><span class="line">useEffect(() &#x3D;&gt; &#123;</span><br><span class="line">    console.log(&#39;hello world&#39;)</span><br><span class="line">  &#125;, [])</span><br><span class="line">&#x2F;&#x2F;componentDidMount componentDidUpdate</span><br><span class="line">const [count, setCount] &#x3D; useState(0);</span><br><span class="line">  useEffect(() &#x3D;&gt; &#123;</span><br><span class="line">    document.title &#x3D; &#96;You clicked $&#123;count&#125; times&#96;;</span><br><span class="line">  &#125;);</span><br><span class="line">&#x2F;&#x2F;componentDidMount componentWillUnmount</span><br><span class="line"> const [count, setCount] &#x3D; useState(0);</span><br><span class="line">  useEffect(() &#x3D;&gt; &#123;</span><br><span class="line">    const id &#x3D; setInterval(() &#x3D;&gt; &#123;</span><br><span class="line">      setCount(c &#x3D;&gt; c + 1);</span><br><span class="line">    &#125;, 1000);</span><br><span class="line">    return () &#x3D;&gt; clearInterval(id);</span><br><span class="line">  &#125;, []);</span><br><span class="line">&#x2F;&#x2F;componentDidUpdate </span><br><span class="line">const [count, setCount] &#x3D; useState(0);</span><br><span class="line">  const prevCountRef &#x3D; useRef(false);</span><br><span class="line">  useEffect(() &#x3D;&gt; &#123;</span><br><span class="line">    if (prevCountRef.current) &#123;</span><br><span class="line">      console.log(&#39;更新时候的数据&#39;)</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      prevCountRef.current &#x3D; true</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">mikasa</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://yoursite.com/2020/11/30/SSR%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%B8%B2%E6%9F%93/">http://yoursite.com/2020/11/30/SSR%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%B8%B2%E6%9F%93/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://yoursite.com" target="_blank">mikasa</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://ss0.bdstatic.com/70cFuHSh_Q1YnxGkpoWK1HF6hhy/it/u=3519339501,3990679385&amp;fm=26&amp;gp=0.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/11/30/nodejs%E8%BF%9B%E9%98%B6/"><img class="prev-cover" src="https://ss0.bdstatic.com/70cFuHSh_Q1YnxGkpoWK1HF6hhy/it/u=3647242472,1193660820&amp;fm=26&amp;gp=0.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Nodejs进阶</div></div></a></div><div class="next-post pull-right"><a href="/2020/11/30/js/"><img class="next-cover" src="https://ss1.bdstatic.com/70cFuXSh_Q1YnxGkpoWK1HF6hhy/it/u=4234896097,4021899470&amp;fm=26&amp;gp=0.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">JavaScript基础</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside_content" id="aside_content"><div class="card-widget card-info"><div class="card-content"><div class="card-info-avatar is-center"><img class="avatar-img" src="/img/index/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">mikasa</div><div class="author-info__description">Java,JavaScript,Node,Json,Sql,前端,数据库,后端</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">55</div></a></div><div class="card-info-data-item is-center"><a href="/source/categories/"><div class="headline">分类</div><div class="length-num">15</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/zcz147258"><i class="fab fa-github"></i><span>Follow Me</span></a></div></div><div class="card-widget card-announcement"><div class="card-content"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">有缘人哦吼！</div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="card-content"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-SSR%E7%9A%84%E4%BC%98%E7%82%B9%E5%92%8C%E7%BC%BA%E7%82%B9"><span class="toc-number">1.</span> <span class="toc-text">1.SSR的优点和缺点</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-Nuxt-js"><span class="toc-number">2.</span> <span class="toc-text">2.Nuxt.js</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1%E5%AE%89%E8%A3%85"><span class="toc-number">2.1.</span> <span class="toc-text">2.1安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2%E7%9B%AE%E5%BD%95%E4%BB%8B%E7%BB%8D"><span class="toc-number">2.2.</span> <span class="toc-text">2.2目录介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3%E8%B7%AF%E7%94%B1"><span class="toc-number">2.3.</span> <span class="toc-text">2.3路由</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4%E5%8A%A8%E6%80%81%E8%B7%AF%E7%94%B1"><span class="toc-number">2.4.</span> <span class="toc-text">2.4动态路由</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-5%E8%BF%87%E5%BA%A6"><span class="toc-number">2.5.</span> <span class="toc-text">2.5过度</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-6%E9%BB%98%E8%AE%A4%E6%A8%A1%E6%9D%BF%E5%92%8C%E9%BB%98%E8%AE%A4%E5%B8%83%E5%B1%80"><span class="toc-number">2.6.</span> <span class="toc-text">2.6默认模板和默认布局</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-7%E9%94%99%E8%AF%AF%E9%A1%B5%E9%9D%A2%E5%92%8C%E4%B8%AA%E6%80%A7meta%E6%A0%87%E7%AD%BE%E8%AE%BE%E7%BD%AE"><span class="toc-number">2.7.</span> <span class="toc-text">2.7错误页面和个性meta标签设置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-8%E5%BC%82%E6%AD%A5%E8%AF%B7%E6%B1%82%E6%95%B0%E6%8D%AE"><span class="toc-number">2.8.</span> <span class="toc-text">2.8异步请求数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-9%E7%94%9F%E6%88%90%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90"><span class="toc-number">2.9.</span> <span class="toc-text">2.9生成静态资源</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-Next-js"><span class="toc-number">3.</span> <span class="toc-text">3.Next.js</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1%E5%88%9B%E5%BB%BA"><span class="toc-number">3.1.</span> <span class="toc-text">3.1创建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-page%E5%92%8Ccomponent%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 page和component的使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2%E8%B7%AF%E7%94%B1%E8%B7%B3%E8%BD%AC"><span class="toc-number">3.3.</span> <span class="toc-text">3.2路由跳转</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3%E8%B7%AF%E7%94%B1%E8%B7%B3%E8%BD%AC%E4%BC%A0%E9%80%92%E5%8F%82%E6%95%B0%E6%8E%A5%E6%94%B6%E5%8F%82%E6%95%B0"><span class="toc-number">3.4.</span> <span class="toc-text">3.3路由跳转传递参数接收参数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4%E8%B7%AF%E7%94%B1%E4%B8%AD%E7%9A%84%E9%92%A9%E5%AD%90%E4%BA%8B%E4%BB%B6"><span class="toc-number">3.5.</span> <span class="toc-text">3.4路由中的钩子事件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-5%E8%8E%B7%E5%8F%96%E8%BF%9C%E7%AB%AF%E6%95%B0%E6%8D%AEaxios"><span class="toc-number">3.6.</span> <span class="toc-text">3.5获取远端数据axios</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-6css%E6%A0%B7%E5%BC%8F"><span class="toc-number">3.7.</span> <span class="toc-text">3.6css样式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-7moment-js-%E5%A4%84%E7%90%86%E6%97%B6%E9%97%B4"><span class="toc-number">3.8.</span> <span class="toc-text">3.7moment.js  处理时间</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-8SEO"><span class="toc-number">3.9.</span> <span class="toc-text">3.8SEO</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-9%E6%89%93%E5%8C%85%E7%9A%84%E5%9D%91"><span class="toc-number">3.10.</span> <span class="toc-text">3.9打包的坑</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-vue-SSR%E6%B8%B2%E6%9F%93"><span class="toc-number">4.</span> <span class="toc-text">4.vue-SSR渲染</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1%E9%A2%84%E6%B8%B2%E6%9F%93"><span class="toc-number">4.1.</span> <span class="toc-text">4.1预渲染</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2SSR"><span class="toc-number">4.2.</span> <span class="toc-text">4.2SSR</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-1webpack-server-conf-js"><span class="toc-number">4.2.1.</span> <span class="toc-text">4.2.1webpack.server.conf.js</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-2-entry-server-js"><span class="toc-number">4.2.2.</span> <span class="toc-text">4.2.2  entry-server.js</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-3%E4%BF%AE%E6%94%B9%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F"><span class="toc-number">4.2.3.</span> <span class="toc-text">4.2.3修改工厂模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-4%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%B8%B2%E6%9F%93"><span class="toc-number">4.2.4.</span> <span class="toc-text">4.2.4客户端渲染</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-5%E6%95%B0%E6%8D%AE%E9%A2%84%E5%8F%96%E5%92%8C%E5%AD%98%E5%82%A8"><span class="toc-number">4.2.5.</span> <span class="toc-text">5.2.5数据预取和存储</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-6%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%85%A5%E5%8F%A3"><span class="toc-number">4.2.6.</span> <span class="toc-text">5.2.6客户端入口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-7%E6%9C%8D%E5%8A%A1%E7%AB%AF"><span class="toc-number">4.2.7.</span> <span class="toc-text">5.3.7服务端</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-8%E7%83%AD%E6%9B%B4%E6%96%B0%E5%92%8C%E6%9C%AC%E5%9C%B0%E8%B0%83%E8%AF%95"><span class="toc-number">4.2.8.</span> <span class="toc-text">5.3.8热更新和本地调试</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-nextjs-%E5%8D%9A%E5%AE%A2%E5%AE%9E%E6%88%98"><span class="toc-number">5.</span> <span class="toc-text">5.nextjs 博客实战</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1%E5%87%86%E5%A4%87"><span class="toc-number">5.1.</span> <span class="toc-text">5.1准备</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2%E5%AE%9E%E6%88%98%E5%A4%B4%E9%83%A8"><span class="toc-number">5.2.</span> <span class="toc-text">5.2实战头部</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-3markdown%E4%BB%A3%E7%A0%81%E9%AB%98%E4%BA%AE"><span class="toc-number">5.3.</span> <span class="toc-text">5.3markdown代码高亮</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-4Hooks%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">5.4.</span> <span class="toc-text">5.4Hooks的使用</span></a></li></ol></li></ol></div></div></div><div class="card-widget card-recent-post"><div class="card-content"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2020/12/16/generator%E5%92%8Citerator/" title="generator和iterator"><img src="https://ss1.bdstatic.com/70cFuXSh_Q1YnxGkpoWK1HF6hhy/it/u=4234896097,4021899470&amp;fm=26&amp;gp=0.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="generator和iterator"/></a><div class="content"><a class="title" href="/2020/12/16/generator%E5%92%8Citerator/" title="generator和iterator">generator和iterator</a><time datetime="2020-12-16T03:42:48.398Z" title="发表于 2020-12-16 11:42:48">2020-12-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/12/16/js%E5%8A%A0%E8%A7%A3%E5%AF%86crypto.js/" title="js加解密"><img src="https://ss1.bdstatic.com/70cFuXSh_Q1YnxGkpoWK1HF6hhy/it/u=4234896097,4021899470&amp;fm=26&amp;gp=0.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="js加解密"/></a><div class="content"><a class="title" href="/2020/12/16/js%E5%8A%A0%E8%A7%A3%E5%AF%86crypto.js/" title="js加解密">js加解密</a><time datetime="2020-12-16T03:41:57.061Z" title="发表于 2020-12-16 11:41:57">2020-12-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/12/16/js%E5%AF%B9%E8%B1%A1%E6%95%B0%E7%BB%84%E6%8E%92%E5%BA%8F/" title="js对象数组排序"><img src="https://ss1.bdstatic.com/70cFuXSh_Q1YnxGkpoWK1HF6hhy/it/u=4234896097,4021899470&amp;fm=26&amp;gp=0.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="js对象数组排序"/></a><div class="content"><a class="title" href="/2020/12/16/js%E5%AF%B9%E8%B1%A1%E6%95%B0%E7%BB%84%E6%8E%92%E5%BA%8F/" title="js对象数组排序">js对象数组排序</a><time datetime="2020-12-16T03:40:27.119Z" title="发表于 2020-12-16 11:40:27">2020-12-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/12/16/React%E7%88%B6%E5%AD%90%E8%B0%83%E7%94%A8%E6%96%B9%E6%B3%95/" title="React父子方法调用"><img src="https://ss3.bdstatic.com/70cFv8Sh_Q1YnxGkpoWK1HF6hhy/it/u=2431606259,2554064138&amp;fm=26&amp;gp=0.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="React父子方法调用"/></a><div class="content"><a class="title" href="/2020/12/16/React%E7%88%B6%E5%AD%90%E8%B0%83%E7%94%A8%E6%96%B9%E6%B3%95/" title="React父子方法调用">React父子方法调用</a><time datetime="2020-12-16T03:39:04.218Z" title="发表于 2020-12-16 11:39:04">2020-12-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/12/16/antd%E8%A1%A8%E5%8D%95%E9%AA%8C%E8%AF%81/" title="antd表单验证"><img src="https://ss3.bdstatic.com/70cFv8Sh_Q1YnxGkpoWK1HF6hhy/it/u=2431606259,2554064138&amp;fm=26&amp;gp=0.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="antd表单验证"/></a><div class="content"><a class="title" href="/2020/12/16/antd%E8%A1%A8%E5%8D%95%E9%AA%8C%E8%AF%81/" title="antd表单验证">antd表单验证</a><time datetime="2020-12-16T03:38:14.395Z" title="发表于 2020-12-16 11:38:14">2020-12-16</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 By mikasa</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">簡</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    let initData = {
      el: '#vcomment',
      appId: 'BzB1So5EWrOm2CUDceS299It-gzGzoHsz',
      appKey: 'Ul1N9MAsFqovsupOVB5eoJee',
      placeholder: '记得留下你的暱称和邮箱....可以快速收到回復',
      avatar: 'monsterid',
      meta: 'nick,mail,link'.split(','),
      pageSize: '10',
      lang: 'zh-CN',
      recordIP: false,
      serverURLs: '',
      emojiCDN: '',
      emojiMaps: "",
      enableQQ: false,
      path: window.location.pathname,
    }

    if (true) { 
      initData.requiredFields= ('nick,mail'.split(','))
    }
    
    if (false) {
      const otherData = false
      initData = Object.assign({}, initData, otherData)
    }
    
    const valine = new Valine(initData)
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !true) {
  if (true) btf.loadComment(document.querySelector('#vcomment'),loadValine)
  else setTimeout(() => loadValine(), 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><div class="aplayer no-destroy" data-id="2484225391" data-server="netease" data-type="playlist" data-fixed="true" data-mini="true" data-listFolded="false" data-order="random" data-preload="none" data-autoplay="true" muted></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="false"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/gh/metowolf/MetingJS@1.2/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = [
  'title',
  '#config_change',
  '#body-wrap',
  '#rightside-config-hide',
  '#rightside-config-show',
  '.js-pjax'
]

if (false) {
  pjaxSelectors.unshift('meta[property="og:image"]', 'meta[property="og:title"]', 'meta[property="og:url"]')
}

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  if (typeof gtag === 'function') {
    gtag('config', '', {'page_path': window.location.pathname});
  }

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // Analytics
  if (false) {
    MtaH5.pgv()
  }

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})


document.addEventListener('pjax:send', function () {
  typeof preloader === 'object' && preloader.initLoading()
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

})</script></div></body></html>